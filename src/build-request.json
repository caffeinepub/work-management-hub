{
  "kind": "build_request",
  "title": "Fix superadmin claim authorization by adding superadmin role to access-control",
  "projectName": "Asistenku Internal System",
  "priority": "high",
  "requirements": [
    {
      "id": "REQ-4",
      "text": "Update the UserRole enum in backend/access-control.mo to include the #superadmin variant alongside existing role variants (#admin, #user)",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-latest"
        ],
        "quotes": [
          "Saya mengalami stuck dalam mengclaim superadmin karena unauthorized. Only admin can asssign role."
        ]
      },
      "acceptanceCriteria": [
        "The UserRole type in access-control.mo includes #superadmin as a valid variant",
        "The enum definition matches the pattern: type UserRole = { #admin; #superadmin; #user; }"
      ]
    },
    {
      "id": "REQ-5",
      "text": "Modify the isAdmin function in backend/access-control.mo to return true when the user role is either #admin or #superadmin, using the pattern: let role = getUserRole(state, caller); return role == #admin or role == #superadmin;",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-latest"
        ],
        "quotes": [
          "Only admin can asssign role"
        ]
      },
      "acceptanceCriteria": [
        "The isAdmin function returns true for principals with #admin role",
        "The isAdmin function returns true for principals with #superadmin role",
        "The isAdmin function returns false for principals with #user role or no role",
        "The implementation uses boolean OR logic to check both role conditions"
      ]
    },
    {
      "id": "REQ-6",
      "text": "Ensure the Superadmin principal is automatically assigned the #superadmin role in AccessControlState when claiming superadmin privileges in main.mo (around line 365-367), either by calling AccessControl.assignRole with #superadmin after setting role = #superadmin and status = #active, or by implementing a bypass mechanism in access-control.mo that skips the isAdmin check when the caller already has #superadmin role in the main user system",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-latest"
        ]
      },
      "acceptanceCriteria": [
        "When a user successfully claims superadmin privileges via main.mo, they are automatically registered with #superadmin role in the access-control state",
        "The first superadmin claim completes without triggering 'Unauthorized: Only admins can assign user roles' error",
        "Subsequent role assignments by the superadmin work correctly",
        "The solution maintains consistency between the main.mo user role system and the access-control.mo authorization system"
      ]
    }
  ],
  "constraints": [
    "Maintain the single-actor architecture with all Motoko logic in backend/main.mo",
    "Preserve existing access-control.mo API and function signatures where possible",
    "Do not modify the existing user role structure in main.mo (#superadmin, #admin, #finance, #concierge, #strategicPartner, #asistenmu, #client, #partner)",
    "Ensure backward compatibility with existing users who already have roles assigned"
  ],
  "nonGoals": [
    "Adding new user roles beyond #superadmin to access-control.mo",
    "Changing the frontend authentication or registration flows",
    "Modifying the Internet Identity integration",
    "Implementing additional access control features beyond fixing the superadmin claim issue"
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  }
}