{
  "kind": "build_request",
  "title": "Add getAllUsers backend query and fix frontend Motoko variant filtering logic",
  "priority": "high",
  "requirements": [
    {
      "id": "REQ-5",
      "text": "Add a new query function getAllUsers() to backend/main.mo that returns all users from the users map as an array. The function must include authorization check using isAuthorizedAdmin(caller) and trap with 'Unauthorized: Only Admins can view all users' if caller is not authorized. Use Iter.toArray(users.vals()) to convert the map values to an array.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-user-data-issue"
        ],
        "quotes": [
          "Tolong tambahkan satu fungsi query baru ini agar frontend bisa mengambil seluruh data user: public query ({ caller }) func getAllUsers() : async [User]"
        ]
      },
      "acceptanceCriteria": [
        "getAllUsers() query function exists in backend/main.mo",
        "Function checks authorization using isAuthorizedAdmin(caller)",
        "Function traps with 'Unauthorized: Only Admins can view all users' for unauthorized callers",
        "Function returns all users from the users map as an array using Iter.toArray(users.vals())"
      ]
    },
    {
      "id": "REQ-6",
      "text": "Update UserManagementPage.tsx to fetch combinedUsers data from backendActor.getAllUsers() instead of the current data source.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-user-data-issue"
        ],
        "quotes": [
          "Pastikan variabel combinedUsers di-fetch dari await backendActor.getAllUsers()"
        ]
      },
      "acceptanceCriteria": [
        "combinedUsers variable in UserManagementPage.tsx is populated by calling backendActor.getAllUsers()",
        "Data fetching includes proper error handling and loading states"
      ]
    },
    {
      "id": "REQ-7",
      "text": "Fix the status and role filtering logic in UserManagementPage.tsx to correctly handle Motoko variants which become JavaScript objects like { active: null } or { pending: null }. Replace all === comparisons with 'in' operator checks. For Pending users: filter using 'pending' in u.status. For Internal Active users: filter using 'active' in u.status && ('superadmin' in u.role || 'admin' in u.role || 'finance' in u.role || 'concierge' in u.role || 'asistenmu' in u.role). For Partner Active users: filter using 'active' in u.status && ('partner' in u.role || 'strategicPartner' in u.role). For Client Active users: filter using 'active' in u.status && 'client' in u.role.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-user-data-issue"
        ],
        "quotes": [
          "Variant Motoko di JS menjadi Object seperti { active: null }, BUKAN string. Jadi Anda tidak bisa memakai ===. Gunakan operator in atau Object.keys()"
        ]
      },
      "acceptanceCriteria": [
        "All status filters in UserManagementPage.tsx use 'in' operator instead of === for variant checking",
        "Pending users are filtered using 'pending' in u.status",
        "Internal Active users are filtered using 'active' in u.status combined with role checks for superadmin, admin, finance, concierge, and asistenmu",
        "Partner Active users are filtered using 'active' in u.status combined with role checks for partner and strategicPartner",
        "Client Active users are filtered using 'active' in u.status && 'client' in u.role",
        "Active users statistics and table display correct counts and data after filtering"
      ]
    }
  ],
  "constraints": [
    "Use the existing isAuthorizedAdmin function for authorization checking in getAllUsers",
    "Maintain consistency with existing Map library usage in backend for toArray conversion",
    "Do not modify the User type definition or existing user management functions beyond adding getAllUsers"
  ],
  "nonGoals": [
    "Changing the overall user management architecture",
    "Modifying role or status type definitions",
    "Adding new user roles or statuses",
    "Implementing pagination for user lists"
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  }
}