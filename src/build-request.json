{
  "kind": "build_request",
  "title": "Implement Part 3: Task Status Updates, Financial Completion, and Client View Masking",
  "projectName": "Work Management Hub",
  "priority": "normal",
  "requirements": [
    {
      "id": "REQ-5",
      "text": "Implement updateTaskStatus function that accepts taskId and newStatus (TaskStatus) as parameters, updates the task's status field to the new status value for managing revision cycles (OnProgress → InQA → ClientReview → Revision → OnProgress)",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-recent"
        ],
        "quotes": [
          "updateTaskStatus (Update Call - Dipanggil AM/Client): Menerima parameter `taskId` dan `newStatus` (TaskStatus). Logic: Fungsi ini digunakan untuk memutar siklus revisi"
        ]
      },
      "acceptanceCriteria": [
        "Function accepts taskId and newStatus parameters",
        "Updates the task's status field to newStatus",
        "Returns success or error result"
      ]
    },
    {
      "id": "REQ-6",
      "text": "Implement completeTask function as the financial trigger that: (1) accepts taskId parameter, (2) retrieves task and layanan data, (3) burns units by subtracting task.estimasiJam from layanan.jamOnHold, (4) calculates partner payment using jamEfektif from task.internalData multiplied by hourly rate based on partner level (Junior: 35,000, Senior: 55,000, Expert: 75,000), (5) includes pseudo-code comment for adding pendapatanPartner to partner balance, (6) changes task status to Completed, and (7) returns success message with financial calculations",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-recent"
        ],
        "quotes": [
          "completeTask (Update Call - THE FINANCIAL TRIGGER)",
          "Eksekusi Burn Unit: `layanan.jamOnHold -= task.estimasiJam`",
          "Kalkulasi Pembayaran Partner: Ambil nilai `jamEfektif` dari `task.internalData`. Tentukan hourly rate berdasarkan level Partner (Gunakan mockup ini: Junior = 35_000, Senior = 55_000, Expert = 75_000)"
        ]
      },
      "acceptanceCriteria": [
        "Function accepts taskId parameter",
        "Burns units from layanan.jamOnHold by subtracting task.estimasiJam",
        "Calculates partner payment: jamEfektif × hourly rate (Junior: 35k, Senior: 55k, Expert: 75k)",
        "Includes TODO pseudo-code comment for updating partner balance",
        "Sets task status to Completed",
        "Returns success message with financial calculation details",
        "Includes clear comments marking the financial trigger logic"
      ]
    },
    {
      "id": "REQ-7",
      "text": "Implement getClientTasks query function that: (1) accepts clientId (Principal) parameter, (2) filters tasks by clientId, (3) maps each task to TaskClientView type, (4) implements masking logic where PendingPartner and RejectedByPartner statuses display as 'Sedang Didelegasikan' (hiding rejections from client), (5) converts other statuses to user-friendly strings (OnProgress → 'Sedang Dikerjakan', InQA → 'Quality Assurance'), (6) excludes internalData field from the returned view, and (7) returns array of TaskClientView with clear comments marking the masking logic",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-recent"
        ],
        "quotes": [
          "getClientTasks (Query Call - THE MASKING VIEW)",
          "ATURAN MASKING STATUS (Wajib): Jika status `#PendingPartner` ATAU `#RejectedByPartner`, maka field `statusTampil` harus berisi string 'Sedang Didelegasikan'",
          "Pastikan field rahasia seperti `internalData` TIDAK MASUK ke dalam return view ini"
        ]
      },
      "acceptanceCriteria": [
        "Function accepts clientId parameter",
        "Filters tasks belonging to the specified client",
        "Maps tasks to TaskClientView type",
        "Masks PendingPartner and RejectedByPartner statuses as 'Sedang Didelegasikan'",
        "Converts other statuses to user-friendly display strings",
        "Excludes internalData field from the returned view",
        "Returns array of TaskClientView objects",
        "Includes clear comments marking the masking logic"
      ]
    }
  ],
  "constraints": [
    "Maintain consistency with existing Task and Layanan data structures",
    "Use hourly rates exactly as specified: Junior = 35,000, Senior = 55,000, Expert = 75,000",
    "Ensure internalData field is never exposed in client-facing queries",
    "Keep all logic within the single-actor architecture in backend/main.mo"
  ],
  "nonGoals": [
    "Implementing actual partner balance updates (pseudo-code comment only)",
    "Creating new frontend components for these functions",
    "Modifying existing task creation or approval flows",
    "Adding database persistence beyond in-memory state"
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  }
}